<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>3.30一周拾遗 | GTX Ultimate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本周主要围绕PHP的内部实现做了探索，同时进行诸多面试。并且收到了新浪实习offer以及金山西山居的邀请。当然是前者优先了。 一些杂项的积累PHP配置文件找不到怎么破使用PHP的phpinfo();来进行查找 123456// PHP CLIphp -r &amp;quot;phpinfo()&amp;quot; | grep &amp;quot;Loaded Configuration File&amp;quot; &amp;amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="3.30一周拾遗">
<meta property="og:url" content="http://yoursite.com/2018/03/30/weekend2/index.html">
<meta property="og:site_name" content="GTX Ultimate">
<meta property="og:description" content="本周主要围绕PHP的内部实现做了探索，同时进行诸多面试。并且收到了新浪实习offer以及金山西山居的邀请。当然是前者优先了。 一些杂项的积累PHP配置文件找不到怎么破使用PHP的phpinfo();来进行查找 123456// PHP CLIphp -r &amp;quot;phpinfo()&amp;quot; | grep &amp;quot;Loaded Configuration File&amp;quot; &amp;amp;">
<meta property="og:locale" content="ja">
<meta property="og:updated_time" content="2018-03-30T11:53:31.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="3.30一周拾遗">
<meta name="twitter:description" content="本周主要围绕PHP的内部实现做了探索，同时进行诸多面试。并且收到了新浪实习offer以及金山西山居的邀请。当然是前者优先了。 一些杂项的积累PHP配置文件找不到怎么破使用PHP的phpinfo();来进行查找 123456// PHP CLIphp -r &amp;quot;phpinfo()&amp;quot; | grep &amp;quot;Loaded Configuration File&amp;quot; &amp;amp;">
  
    <link rel="alternate" href="/atom.xml" title="GTX Ultimate" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">GTX Ultimate</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Force Or Blood</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSSフィード"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="検索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-weekend2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/30/weekend2/" class="article-date">
  <time datetime="2018-03-30T06:51:27.000Z" itemprop="datePublished">2018-03-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      3.30一周拾遗
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本周主要围绕PHP的内部实现做了探索，同时进行诸多面试。并且收到了新浪实习offer以及金山西山居的邀请。当然是前者优先了。</p>
<h1 id="一些杂项的积累"><a href="#一些杂项的积累" class="headerlink" title="一些杂项的积累"></a>一些杂项的积累</h1><h3 id="PHP配置文件找不到怎么破"><a href="#PHP配置文件找不到怎么破" class="headerlink" title="PHP配置文件找不到怎么破"></a>PHP配置文件找不到怎么破</h3><p>使用PHP的phpinfo();来进行查找</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// PHP CLI</span><br><span class="line"></span><br><span class="line">php -r &quot;phpinfo()&quot; | grep &quot;Loaded Configuration File&quot; &amp;&amp; &quot;Configuration FIle&quot;；</span><br><span class="line">// 但是找不到Loaded怎么办 或者Loaded出来是 none</span><br><span class="line">// 一般是新的PHP没有将PHP.ini放到指定位置 </span><br><span class="line">// 原始的PHPINI可以从源码包找到 php.ini.production cp过去就可以了</span><br></pre></td></tr></table></figure>
<h3 id="Segment-Fault-段错误-怎么进行debug"><a href="#Segment-Fault-段错误-怎么进行debug" class="headerlink" title="Segment Fault 段错误 怎么进行debug"></a>Segment Fault 段错误 怎么进行debug</h3><p>首先Linux系统默认是不dump Core的 需要设置unlimit 让系统对Fault的Core进行Dump</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ulimit -c unlimited</span><br></pre></td></tr></table></figure>
<p>就可以将出错时的内核文件进行输出 .Core.XXXX文件</p>
<p>然后 yum install gdb 然后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb php core.XXXX 进行分析 可以找出出错的行数</span><br></pre></td></tr></table></figure>
<h3 id="未解决问题-对PHP扩展开发的时候-return-value-used变量不能用"><a href="#未解决问题-对PHP扩展开发的时候-return-value-used变量不能用" class="headerlink" title="[未解决问题] 对PHP扩展开发的时候 return_value_used变量不能用"></a>[未解决问题] 对PHP扩展开发的时候 return_value_used变量不能用</h3><p>提示未定义 而且在源码包内对PHP_FUNCTION的宏定义中找不到这个变量 难道是PHP7更新之后自动可以GC的缘故？</p>
<h1 id="Redis-内存数据库数据结构整理"><a href="#Redis-内存数据库数据结构整理" class="headerlink" title="Redis 内存数据库数据结构整理"></a>Redis 内存数据库数据结构整理</h1><h3 id="SDS-（动态字符串）"><a href="#SDS-（动态字符串）" class="headerlink" title="SDS （动态字符串）"></a>SDS （动态字符串）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">struct sdshdr &#123;</span><br><span class="line">	int len; // SDS遵循C字符串以 &apos;\0&apos;为结尾的规则 但是 末尾的空不计算在len内</span><br><span class="line">	// 这样获取的长度的速度就是O(1)</span><br><span class="line">	// 还可以杜绝缓冲区溢出 在操作之前可以先看一下是否有足够的空间 如果没有就malloc C语言本身不记录string的长度</span><br><span class="line">	// 减少修改字符串带来的内存重新分配次数</span><br><span class="line">	int free;</span><br><span class="line">	char buf[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SDS使用空间预分配和惰性空间释放策略 提升性能</p>
<h4 id="空间与分配："><a href="#空间与分配：" class="headerlink" title="空间与分配："></a>空间与分配：</h4><p>如果小于1MB</p>
<p>预分配相同的size</p>
<p>如果大于1MB </p>
<p>预分配1MB的size</p>
<h4 id="二进制安全"><a href="#二进制安全" class="headerlink" title="二进制安全"></a>二进制安全</h4><p>避免使用 \0 导致字符串截断</p>
<p>Redis在读取字符串的时候是依据 SDS结构之内的len进行读取 有多少读多少</p>
<h4 id="对比C字符串的优点"><a href="#对比C字符串的优点" class="headerlink" title="对比C字符串的优点"></a>对比C字符串的优点</h4><ul>
<li><p>O(1)获取长度复杂度</p>
</li>
<li><p>杜绝缓冲区溢出</p>
</li>
<li><p>减少修改字符串带来的内存重新分配次数</p>
</li>
<li><p>二进制安全</p>
</li>
</ul>
<h3 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h3><p>链表提供高效的结点重排能力</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">typedef struct listNode &#123;</span><br><span class="line">	struct listNode *prev;</span><br><span class="line">	struct listNode *next;</span><br><span class="line">	void *value;</span><br><span class="line">&#125;listNode;</span><br><span class="line"></span><br><span class="line">typedef struct list &#123;</span><br><span class="line">	listNode *head;</span><br><span class="line">	listNode *tail;</span><br><span class="line">	unsigned long len;</span><br><span class="line">	void *(*dup)(void *ptr)</span><br><span class="line">	void *(*free)(void *ptr)</span><br><span class="line">	int (*match)(void *ptr)</span><br><span class="line">&#125;list;</span><br></pre></td></tr></table></figure>
<h4 id="API时间复杂度"><a href="#API时间复杂度" class="headerlink" title="API时间复杂度"></a>API时间复杂度</h4><ul>
<li><p>返回值所在的index O(N)</p>
</li>
<li><p>返回index所在的值 O(N)</p>
</li>
<li><p>删除指定结点O(N)</p>
</li>
<li><p>复制一个副本O(N)</p>
</li>
<li><p>释放链表 O(N)</p>
</li>
</ul>
<h3 id="字典—使用哈希表实现"><a href="#字典—使用哈希表实现" class="headerlink" title="字典—使用哈希表实现"></a>字典—使用哈希表实现</h3><p>又被称为符号表、关联数组、或者映射</p>
<p>字典使用哈希表实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">typedef struct dictEntry&#123; // 哈希表结点</span><br><span class="line">	void *key;</span><br><span class="line">	</span><br><span class="line">	union &#123;</span><br><span class="line">	 // 同样采用联合体来节约内存</span><br><span class="line">		void *val;</span><br><span class="line">		uint64 _tu64;</span><br><span class="line">		int64 _ts64;</span><br><span class="line">	&#125;v;</span><br><span class="line">	struct dictEntry *next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">typedef struct dict&#123;</span><br><span class="line">	dictType *type;</span><br><span class="line">	void *privdata;</span><br><span class="line">	</span><br><span class="line">	dictht ht[2];</span><br><span class="line">	</span><br><span class="line">	// 平时数据会存在第一个HashTable 当进行rehash的时候使用第二个HashTable</span><br><span class="line">		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="解决HashTable的方法"><a href="#解决HashTable的方法" class="headerlink" title="解决HashTable的方法"></a>解决HashTable的方法</h4><p>有链接法和开放寻址法</p>
<p>链接法就是当发生index冲突的时候，在index处形成链表，新插入的在前面</p>
<p>开放寻址法就是发生index冲突的时候，自动向下寻址</p>
<h4 id="HashTable的API时间复杂度"><a href="#HashTable的API时间复杂度" class="headerlink" title="HashTable的API时间复杂度"></a>HashTable的API时间复杂度</h4><ul>
<li><p>向HashTable加新的元素 O(1)</p>
</li>
<li><p>释放HashTable O(N)</p>
</li>
</ul>
<h3 id="跳跃表-有序set的实现之一"><a href="#跳跃表-有序set的实现之一" class="headerlink" title="跳跃表-有序set的实现之一"></a>跳跃表-有序set的实现之一</h3><p>跳跃表支持平均O(logN)、最坏O(N)的复杂度查找</p>
<p>。。。说实话跳跃表没咋看懂</p>
<h4 id="跳跃表API时间复杂度"><a href="#跳跃表API时间复杂度" class="headerlink" title="跳跃表API时间复杂度"></a>跳跃表API时间复杂度</h4><ul>
<li><p>寻找 删除 返回排位 平均O(logN) 最坏O(N)</p>
</li>
<li><p>给定一个范围 如果有一个在范围之内 就可以 O(1)</p>
</li>
</ul>
<h3 id="整数集合-set的单纯整数实现"><a href="#整数集合-set的单纯整数实现" class="headerlink" title="整数集合 set的单纯整数实现"></a>整数集合 set的单纯整数实现</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typedef struct intset&#123;</span><br><span class="line">	uint32_t encoding;</span><br><span class="line">	</span><br><span class="line">	uint32_t length;</span><br><span class="line">	</span><br><span class="line">	int 8_t content[]; // 不仅会保存int8的数据 保存类型取决于encoding;</span><br><span class="line">&#125;intset;</span><br></pre></td></tr></table></figure>
<h4 id="整数集合API时间复杂度"><a href="#整数集合API时间复杂度" class="headerlink" title="整数集合API时间复杂度"></a>整数集合API时间复杂度</h4><ul>
<li><p>添加新元素复杂度为O(N) // 因为每次操作都可能引起升级  所以会大一点</p>
</li>
<li><p>整数集合不会降级 保证性能</p>
</li>
</ul>
<h3 id="压缩列表-列表键和哈希键的实现之一"><a href="#压缩列表-列表键和哈希键的实现之一" class="headerlink" title="压缩列表 列表键和哈希键的实现之一"></a>压缩列表 列表键和哈希键的实现之一</h3><p>压缩列表是连续内存构成的顺序结构</p>
<p>[zlbytes, zltail, zllen, entry1, entry2, …, zlend];</p>
<p>zlbytes: 表示压缩列表总长度</p>
<p>zltail： 压缩列表尾部指针P</p>
<p>zllen: 压缩列表数据个数</p>
<p>通过以上三个参数 可以分别计算出每个数据点的指针 从尾部开始计算即可</p>
<h4 id="压缩列表结点构成"><a href="#压缩列表结点构成" class="headerlink" title="压缩列表结点构成"></a>压缩列表结点构成</h4><p>[previous_entry_length, encoding, content]</p>
<p>pre记录了前一个结点的长度</p>
<p>可以根据当前结点的起始地址计算出前一个结点的起始地址指针</p>
<h4 id="压缩列表API时间复杂度"><a href="#压缩列表API时间复杂度" class="headerlink" title="压缩列表API时间复杂度"></a>压缩列表API时间复杂度</h4><ul>
<li><p>创建一个包含指定结点的压缩列表 O(N) 最坏O(N*N)</p>
</li>
<li><p>插入结点 O(N) 最坏O(N*N)</p>
</li>
<li><p>返回index的结点O(N)</p>
</li>
<li><p>找到包含指定值的 O(N) 最坏O(N*N)</p>
</li>
<li><p>删除指定结点 O(N) 最坏O(N*N)</p>
</li>
<li><p>返回结点数量 结点数量小于65535 O(1) 最坏O(N*N)</p>
</li>
</ul>
<h2 id="REDIS对象以及实现"><a href="#REDIS对象以及实现" class="headerlink" title="REDIS对象以及实现"></a>REDIS对象以及实现</h2><h3 id="Redis-string"><a href="#Redis-string" class="headerlink" title="Redis_string"></a>Redis_string</h3><p>int raw embstr;</p>
<h3 id="redis-list"><a href="#redis-list" class="headerlink" title="redis_list"></a>redis_list</h3><p>ziplist hashtable intlist</p>
<h3 id="redis-hash"><a href="#redis-hash" class="headerlink" title="redis_hash"></a>redis_hash</h3><p>ziplist hashtable</p>
<h3 id="redis-set"><a href="#redis-set" class="headerlink" title="redis_set"></a>redis_set</h3><p>intset hashtable</p>
<h3 id="reids-zset"><a href="#reids-zset" class="headerlink" title="reids_zset"></a>reids_zset</h3><p>ziplist skiplist</p>
<h1 id="PHP扩展开发相关【未完待续】"><a href="#PHP扩展开发相关【未完待续】" class="headerlink" title="PHP扩展开发相关【未完待续】"></a>PHP扩展开发相关【未完待续】</h1>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/03/30/weekend2/" data-id="cjfdw3z3y000j4rfyedykl0wa" class="article-share-link">共有</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2018/03/25/weekend1/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前の記事</strong>
      <div class="article-nav-title">3.25周 一周拾遗</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">アーカイブ</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">3月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">2月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最近の投稿</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/03/30/weekend2/">3.30一周拾遗</a>
          </li>
        
          <li>
            <a href="/2018/03/25/weekend1/">3.25周 一周拾遗</a>
          </li>
        
          <li>
            <a href="/2018/03/20/mysql-acid/">MySQL 事务处理</a>
          </li>
        
          <li>
            <a href="/2018/03/20/autoloader/">自动加载以及Composer的实现</a>
          </li>
        
          <li>
            <a href="/2018/03/20/php-code-4/">PHP代码实现3 [函数角度] 1</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 GuoQingZhe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>