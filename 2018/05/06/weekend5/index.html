<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>4.21-5.6周记 | GTX Ultimate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="trashes1234567891011string addslashes ( string $str )返回字符串，该字符串为了数据库查询语句等的需要在某些字符前加上了反斜线。这些字符是单引号（&amp;apos;）、双引号（&amp;quot;）、反斜线（\）与 NUL（NULL 字符）。preg_replace — 执行一个正则表达式的搜索和替换说明mixed preg_replace ( mixed $p">
<meta property="og:type" content="article">
<meta property="og:title" content="4.21-5.6周记">
<meta property="og:url" content="http://yoursite.com/2018/05/06/weekend5/index.html">
<meta property="og:site_name" content="GTX Ultimate">
<meta property="og:description" content="trashes1234567891011string addslashes ( string $str )返回字符串，该字符串为了数据库查询语句等的需要在某些字符前加上了反斜线。这些字符是单引号（&amp;apos;）、双引号（&amp;quot;）、反斜线（\）与 NUL（NULL 字符）。preg_replace — 执行一个正则表达式的搜索和替换说明mixed preg_replace ( mixed $p">
<meta property="og:locale" content="ja">
<meta property="og:updated_time" content="2018-05-06T02:06:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="4.21-5.6周记">
<meta name="twitter:description" content="trashes1234567891011string addslashes ( string $str )返回字符串，该字符串为了数据库查询语句等的需要在某些字符前加上了反斜线。这些字符是单引号（&amp;apos;）、双引号（&amp;quot;）、反斜线（\）与 NUL（NULL 字符）。preg_replace — 执行一个正则表达式的搜索和替换说明mixed preg_replace ( mixed $p">
  
    <link rel="alternate" href="/atom.xml" title="GTX Ultimate" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">GTX Ultimate</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Force Or Blood</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSSフィード"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="検索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-weekend5" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/06/weekend5/" class="article-date">
  <time datetime="2018-05-06T01:19:33.000Z" itemprop="datePublished">2018-05-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      4.21-5.6周记
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="trashes"><a href="#trashes" class="headerlink" title="trashes"></a>trashes</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">string addslashes ( string $str )</span><br><span class="line"></span><br><span class="line">返回字符串，该字符串为了数据库查询语句等的需要在某些字符前加上了反斜线。这些字符是单引号（&apos;）、双引号（&quot;）、反斜线（\）与 NUL（NULL 字符）。</span><br><span class="line"></span><br><span class="line">preg_replace — 执行一个正则表达式的搜索和替换</span><br><span class="line">说明</span><br><span class="line"></span><br><span class="line">mixed preg_replace ( mixed $pattern , mixed $replacement , mixed $subject [, int $limit = -1 [, int &amp;$count ]] )</span><br><span class="line"></span><br><span class="line">搜索subject中匹配pattern的部分， 以replacement进行替换。</span><br></pre></td></tr></table></figure>
<h2 id="PHP-RdKafka-有延时问题"><a href="#PHP-RdKafka-有延时问题" class="headerlink" title="PHP-RdKafka 有延时问题"></a>PHP-RdKafka 有延时问题</h2><p>作者说是因为没有持久链接，所以会出现推卡夫卡之后会有延迟的现象。量级小还可以 但是量大了之后就很难说。会极大的拖慢php-fpm</p>
<h2 id="Vbird-PHP-var-的变化"><a href="#Vbird-PHP-var-的变化" class="headerlink" title="Vbird-PHP-var 的变化"></a>Vbird-PHP-var 的变化</h2><p>PHP5会出现的写时复制 在PHP7中有所改善，改善的目的就是为了节约内存</p>
<p>PHP改进的宗旨就是 更好的缓存友好度 更低的内存使用 更少的操作数 </p>
<p>当在php5中  这样写是很大性能缺憾的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$arr = range(1, 10000);</span><br><span class="line"></span><br><span class="line">$ref_arr = &amp;$arr; // arr被当做了引用 php5的耿直cow导致性能--</span><br><span class="line"></span><br><span class="line">foreach($arr as &amp;item) &#123;&#125;</span><br><span class="line"></span><br><span class="line">// 以上代码在PHP7的性能是PHP5的10000倍左右</span><br></pre></td></tr></table></figure>
<p>为什么会出现这种情况呢？</p>
<p>因为首先PHP7对COW做了优化，不再真正的在引用的时候copy内存</p>
<p>且PHP7对变量的结构体做了优化，结构体由三个Union组成，占24字节</p>
<p>而PHP5的结构体实际占32字节，稍微操作之后大概占48字节，很消耗内存。</p>
<h2 id="Go-sync-Map"><a href="#Go-sync-Map" class="headerlink" title="Go-sync.Map"></a>Go-sync.Map</h2><p>只有Go1.9以上才有的特性</p>
<p>Go的Map并不是线程安全的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line">func main() &#123;</span><br><span class="line">    m := make(map[int]int)</span><br><span class="line">    go func() &#123;</span><br><span class="line">        for &#123;</span><br><span class="line">            _ = m[1]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    go func() &#123;</span><br><span class="line">        for &#123;</span><br><span class="line">            m[2] = 2</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    select &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Go1.9之前，有这样的解决方案 直接对map增加一个sync.Mutex锁进行修补 使其达到线程安全</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var counter = struct&#123;</span><br><span class="line">    sync.RWMutex</span><br><span class="line">    m map[string]int</span><br><span class="line">&#125;&#123;m: make(map[string]int)&#125;</span><br></pre></td></tr></table></figure>
<p>它使用嵌入struct为map增加一个读写锁。</p>
<p>读取数据的时候能够很方便的加锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">counter.RLock()</span><br><span class="line">n := counter.m[&quot;some_key&quot;]</span><br><span class="line">counter.RUnlock()</span><br><span class="line">fmt.Println(&quot;some_key:&quot;, n)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unter.Lock()</span><br><span class="line">counter.m[&quot;some_key&quot;]++</span><br><span class="line">counter.Unlock()</span><br></pre></td></tr></table></figure>
<p>可以说，上面的解决方案相当简洁，并且利用读写锁而不是Mutex可以进一步减少读写的时候因为锁带来的性能。</p>
<p>但是，它在一些场景下也有问题，如果熟悉Java的同学，可以对比一下java的ConcurrentHashMap的实现，在map的数据非常大的情况下，一把锁会导致大并发的客户端共争一把锁，Java的解决方案是shard, 内部使用多个锁，每个区间共享一把锁，这样减少了数据共享一把锁带来的性能影响，orcaman提供了这个思路的一个实现： concurrent-map，他也询问了Go相关的开发人员是否在Go中也实现这种方案，由于实现的复杂性，答案是Yes, we considered it.,但是除非有特别的性能提升和应用场景，否则没有进一步的开发消息。</p>
<p>sync.Map的性能优化点？</p>
<p>空间换时间。 通过冗余的两个数据结构（read、dirty）,实现加锁对性能的影响。</p>
<p>使用只读数据（read），避免读写冲突。</p>
<p>动态调整，miss次数多了之后，将dirty数据提升为read。</p>
<p>double-checking。</p>
<p>延迟删除。 删除一个键值只是打标记，只有在提升dirty的时候才清理删除的数据。</p>
<p>优先从read读取、更新、删除，因为对read的读取不需要锁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">type Map struct &#123;</span><br><span class="line">    // 当涉及到dirty数据的操作的时候，需要使用这个锁</span><br><span class="line">    mu Mutex</span><br><span class="line">    // 一个只读的数据结构，因为只读，所以不会有读写冲突。</span><br><span class="line">    // 所以从这个数据中读取总是安全的。</span><br><span class="line">    // 实际上，实际也会更新这个数据的entries,如果entry是未删除的(unexpunged), 并不需要加锁。如果entry已经被删除了，需要加锁，以便更新dirty数据。</span><br><span class="line">    read atomic.Value // readOnly</span><br><span class="line">    // dirty数据包含当前的map包含的entries,它包含最新的entries(包括read中未删除的数据,虽有冗余，但是提升dirty字段为read的时候非常快，不用一个一个的复制，而是直接将这个数据结构作为read字段的一部分),有些数据还可能没有移动到read字段中。</span><br><span class="line">    // 对于dirty的操作需要加锁，因为对它的操作可能会有读写竞争。</span><br><span class="line">    // 当dirty为空的时候， 比如初始化或者刚提升完，下一次的写操作会复制read字段中未删除的数据到这个数据中。</span><br><span class="line">    dirty map[interface&#123;&#125;]*entry</span><br><span class="line">    // 当从Map中读取entry的时候，如果read中不包含这个entry,会尝试从dirty中读取，这个时候会将misses加一，</span><br><span class="line">    // 当misses累积到 dirty的长度的时候， 就会将dirty提升为read,避免从dirty中miss太多次。因为操作dirty需要加锁。</span><br><span class="line">    misses int</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://studygolang.com/articles/10511" target="_blank" rel="noopener">扩展阅读</a></p>
<h2 id="ISSUE-SVN锁了导致Jenkins无法集成"><a href="#ISSUE-SVN锁了导致Jenkins无法集成" class="headerlink" title="ISSUE-SVN锁了导致Jenkins无法集成"></a>ISSUE-SVN锁了导致Jenkins无法集成</h2><p>SVN的清理命令，我们经常会使用。这个命令的原理，我们还是有必要深究一下的。</p>
<pre><code>当SVN改变你的工作拷贝(或是.svn中的任何信息)，它会尽可能的小心。在进行任何修改操作时，SVN都会把日志记录到日志文件中，然后执行log文件中的命令，
</code></pre><p>并且执行过程中在工作拷贝的相关部分保存一个锁，防止SVN客户端在变更过程中访问工作拷贝。如果SVN的操作中断了（举个例子：进程被杀死了，机器死掉了），</p>
<p>日志文件会保存在硬盘上。通过执行日志文件，SVN可以完成上一次没有完成的操作，你的工作拷贝可以回到一致的状态。</p>
<pre><code>这就是svn clean up命令的功能：它查找工作拷贝中的所有遗留的日志文件，删除进程中工作拷贝的锁。如果SVN告诉你工作拷贝中的一部分已经“锁定”了，
</code></pre><p>你就需要运行这个命令了。</p>
<h2 id="ISSUE-Black-Mac-git-svn报错解决方案"><a href="#ISSUE-Black-Mac-git-svn报错解决方案" class="headerlink" title="ISSUE-Black Mac git-svn报错解决方案"></a>ISSUE-Black Mac git-svn报错解决方案</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Can&apos;t locate SVN/Core.pm in @INC (you may need to install the SVN::Core module) (@INC contains: </span><br><span class="line"></span><br><span class="line">/usr/local/git/lib/perl5/site_perl /Applications/SourceTree.app/Contents/Resources/git_local/lib/perl5/site_perl /Library/Perl/5.18/darwin-thread-multi-2level /Library/Perl/5.18 /Network/Library/Perl/5.18/darwin-thread-multi-2level /Network/Library/Perl/5.18 /Library/Perl/Updates/5.18.2 /System/Library/Perl/5.18/darwin-thread-multi-2level /System/Library/Perl/5.18 /System/Library/Perl/Extras/5.18/darwin-thread-multi-2level /System/Library/Perl/Extras/5.18 .) at /Applications/SourceTree.app/Contents/Resources/git_local/lib/perl5/site_perl/Git/SVN/Editor.pm line 5.</span><br><span class="line"></span><br><span class="line">BEGIN failed--compilation aborted at /Applications/SourceTree.app/Contents/Resources/git_local/lib/perl5/site_perl/Git/SVN/Editor.pm line 5.</span><br><span class="line"></span><br><span class="line">Compilation failed in require at /Applications/SourceTree.app/Contents/Resources/git_local/libexec/git-core/git-svn line 81.</span><br><span class="line"></span><br><span class="line">BEGIN failed--compilation aborted at /Applications/SourceTree.app/Contents/Resources/git_local/libexec/git-core/git-svn line 81.</span><br><span class="line"></span><br><span class="line">Completed with errors, see above</span><br></pre></td></tr></table></figure>
<p>首先百度解决办法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /Applications/Xcode.app/Contents/Developer/Library/Perl/5.18/darwin-thread-multi-2level/SVN/ /Library/Perl/5.18/SVN</span><br><span class="line"></span><br><span class="line">sudo mkdir /Library/Perl/5.18/auto</span><br><span class="line"></span><br><span class="line">sudo ln -s /Applications/Xcode.app/Contents/Developer/Library/Perl/5.18/darwin-thread-multi-2level/auto/SVN/ /Library/Perl/5.18/auto/SVN</span><br></pre></td></tr></table></figure></p>
<p>但是没有XCODE 只在黑苹果的时候装了Xcode command line</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code-select —print-path</span><br></pre></td></tr></table></figure>
<p>拿到相应的地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Developer/CommandLineTools/Library/Perl/5.18/darwin-thread-multi-2level</span><br></pre></td></tr></table></figure>
<p>用这个地址替换上面xcode就行</p>
<h1 id="Go-一次性安装所有dependen"><a href="#Go-一次性安装所有dependen" class="headerlink" title="Go 一次性安装所有dependen"></a>Go 一次性安装所有dependen</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get ./...</span><br></pre></td></tr></table></figure>
<h1 id="Go运行时堆栈分析-dev-shm"><a href="#Go运行时堆栈分析-dev-shm" class="headerlink" title="Go运行时堆栈分析 + dev-shm"></a>Go运行时堆栈分析 + dev-shm</h1><p>Go的内存分配器主要也是解决小对象的分配管理和多线程的内存分配问题。内存分配器以32k作为对象大小的定夺标准，小于等于32k的内存对象一律视为小对象，而大于32k的对象就是大对象了。</p>
<p>Cache、Central、Heap是三个核心组件。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/05/06/weekend5/" data-id="cjj5rq8xn000pddm177xe6qt4" class="article-share-link">共有</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/05/19/which-str-concat-is-fastest/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">次の記事</strong>
      <div class="article-nav-title">
        
          PHP-不同Str 拼接方法性能对比
        
      </div>
    </a>
  
  
    <a href="/2018/04/20/weekend4/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前の記事</strong>
      <div class="article-nav-title">4.7-4.20周记</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">アーカイブ</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">7月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">5月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">4月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">3月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">2月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最近の投稿</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/07/03/weekend6/">GTX log 6</a>
          </li>
        
          <li>
            <a href="/2018/05/24/gitlab-webhook-jenkins/">Gitlab Jenkins WebHook 持续集成配置踩坑记</a>
          </li>
        
          <li>
            <a href="/2018/05/19/which-str-concat-is-fastest/">PHP-不同Str 拼接方法性能对比</a>
          </li>
        
          <li>
            <a href="/2018/05/06/weekend5/">4.21-5.6周记</a>
          </li>
        
          <li>
            <a href="/2018/04/20/weekend4/">4.7-4.20周记</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 GuoQingZhe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>